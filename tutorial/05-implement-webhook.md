---
ms.openlocfilehash: f55eecd4d157c945d0e95870d4e481653b26c9ec
ms.sourcegitcommit: 57a5c2e1a562d8af092a3e78786d711ce1e8f9cb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "48822659"
---
<!-- markdownlint-disable MD002 MD041 -->

<span data-ttu-id="d3bbd-101">В этом упражнении вы завершите реализацию функций Azure `SetSubscription` и `Notify` Обновите тестовое приложение, чтобы подписаться на изменения в папке "Входящие" и отказаться от них.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-101">In this exercise you will finish implementing the Azure Functions `SetSubscription` and `Notify`, and update the test application to subscribe and unsubscribe to changes in a user's inbox.</span></span>

- <span data-ttu-id="d3bbd-102">`SetSubscription`Функция будет действовать как API, позволяя тестовому приложению создавать или удалять [подписку](https://docs.microsoft.com/graph/webhooks) на изменения в папке "Входящие" пользователя.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-102">The `SetSubscription` function will act as an API, allowing the test app to create or delete a [subscription](https://docs.microsoft.com/graph/webhooks) to changes in a user's inbox.</span></span>
- <span data-ttu-id="d3bbd-103">`Notify`Функция будет действовать в качестве веб-перехватчика, который получает уведомления об изменениях, создаваемые подпиской.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-103">The `Notify` function will act as the webhook that receives change notifications generated by the subscription.</span></span>

<span data-ttu-id="d3bbd-104">Обе функции будут использовать [потоки предоставления учетных данных клиента](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) для получения маркера, доступного только для приложений, для вызова Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-104">Both functions will use the [client credentials grant flow](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow) to get an app-only token to call Microsoft Graph.</span></span> <span data-ttu-id="d3bbd-105">Так как администратор предоставил согласие администратора на требуемые области разрешений, для получения маркера не потребуется вмешательство пользователя.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-105">Because an administrator granted admin consent to the required permission scopes, no user interaction will be required to get the token.</span></span>

## <a name="add-client-credentials-authentication-to-the-azure-functions-project"></a><span data-ttu-id="d3bbd-106">Добавление учетных данных клиента проверка подлинности в проект функций Azure</span><span class="sxs-lookup"><span data-stu-id="d3bbd-106">Add client credentials authentication to the Azure Functions project</span></span>

<span data-ttu-id="d3bbd-107">В этом разделе показано, как реализовать потоки учетных данных клиента в проекте функций Azure, чтобы получить маркер доступа, совместимый с Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-107">In this section you'll implement the client credentials flow in the Azure Functions project to get an access token compatible with Microsoft Graph.</span></span>

1. <span data-ttu-id="d3bbd-108">Откройте подсистему CLI в каталоге, содержащем **графтуториал. csproj**.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-108">Open your CLI in the directory that contains **GraphTutorial.csproj**.</span></span>

1. <span data-ttu-id="d3bbd-109">Добавьте идентификатор и секрет приложения веб-перехватчика в Секретное хранилище с помощью следующих команд.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-109">Add your webhook application ID and secret to the secret store using the following commands.</span></span> <span data-ttu-id="d3bbd-110">Замените `YOUR_WEBHOOK_APP_ID_HERE` идентификатором приложения для веб- **перехватчика функции Graph Azure**.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-110">Replace `YOUR_WEBHOOK_APP_ID_HERE` with the application ID for the **Graph Azure Function Webhook**.</span></span> <span data-ttu-id="d3bbd-111">Замените на `YOUR_WEBHOOK_APP_SECRET_HERE` секрет приложения, созданный на портале Azure, для **веб-перехватчика функции Graph Azure**.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-111">Replace `YOUR_WEBHOOK_APP_SECRET_HERE` with the application secret you created in the Azure portal for the **Graph Azure Function Webhook**.</span></span>

    ```Shell
    dotnet user-secrets set webHookId "YOUR_WEBHOOK_APP_ID_HERE"
    dotnet user-secrets set webHookSecret "YOUR_WEBHOOK_APP_SECRET_HERE"
    ```

### <a name="create-a-client-credentials-authentication-provider"></a><span data-ttu-id="d3bbd-112">Создание поставщика проверки подлинности для учетных данных клиента</span><span class="sxs-lookup"><span data-stu-id="d3bbd-112">Create a client credentials authentication provider</span></span>

1. <span data-ttu-id="d3bbd-113">Создайте новый файл в каталоге **./графтуториал/аусентикатион** с именем **ClientCredentialsAuthProvider.CS** и добавьте следующий код.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-113">Create a new file in the **./GraphTutorial/Authentication** directory named **ClientCredentialsAuthProvider.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Authentication/ClientCredentialsAuthProvider.cs" id="AuthProviderSnippet":::

<span data-ttu-id="d3bbd-114">Уделите несколько минут, чтобы определить, что делает код в **ClientCredentialsAuthProvider.CS** .</span><span class="sxs-lookup"><span data-stu-id="d3bbd-114">Take a moment to consider what the code in **ClientCredentialsAuthProvider.cs** does.</span></span>

- <span data-ttu-id="d3bbd-115">В конструкторе он инициализирует **конфидентиалклиентаппликатион** из `Microsoft.Identity.Client` пакета.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-115">In the constructor, it initializes a **ConfidentialClientApplication** from the `Microsoft.Identity.Client` package.</span></span> <span data-ttu-id="d3bbd-116">Она использует `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` функции и, `.WithTenantId(tenantId)` чтобы ограничить аудиторию входа только указанной организацией Microsoft 365.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-116">It uses the `WithAuthority(AadAuthorityAudience.AzureAdMyOrg, true)` and `.WithTenantId(tenantId)` functions to restrict the login audience to only the specified Microsoft 365 organization.</span></span>
- <span data-ttu-id="d3bbd-117">В `GetAccessToken` функции функция вызывается `AcquireTokenForClient` для получения маркера для приложения.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-117">In the `GetAccessToken` function, it calls `AcquireTokenForClient` to get a token for the application.</span></span> <span data-ttu-id="d3bbd-118">Потоки маркеров учетных данных клиента всегда являются неинтерактивными.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-118">The client credentials token flow is always non-interactive.</span></span>
- <span data-ttu-id="d3bbd-119">Он реализует `Microsoft.Graph.IAuthenticationProvider` интерфейс, позволяя передавать этот класс в конструктор `GraphServiceClient` для проверки подлинности исходящих запросов.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-119">It implements the `Microsoft.Graph.IAuthenticationProvider` interface, allowing this class to be passed in the constructor of the `GraphServiceClient` to authenticate outgoing requests.</span></span>

## <a name="update-graphclientservice"></a><span data-ttu-id="d3bbd-120">Обновление Графклиентсервице</span><span class="sxs-lookup"><span data-stu-id="d3bbd-120">Update GraphClientService</span></span>

1. <span data-ttu-id="d3bbd-121">Откройте **GraphClientService.CS** и добавьте в класс следующее свойство.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-121">Open **GraphClientService.cs** and add the following property to the class.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

1. <span data-ttu-id="d3bbd-122">Замените имеющуюся функцию `GetAppGraphClient` указанным ниже кодом.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-122">Replace the existing `GetAppGraphClient` function with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Services/GraphClientService.cs" id="AppGraphClientMembers":::

## <a name="implement-notify-function"></a><span data-ttu-id="d3bbd-123">Реализация функции notify</span><span class="sxs-lookup"><span data-stu-id="d3bbd-123">Implement Notify function</span></span>

<span data-ttu-id="d3bbd-124">В этом разделе описывается реализация `Notify` функции, которая будет использоваться в качестве URL-адреса уведомления для уведомлений об изменениях.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-124">In this section you'll implement the `Notify` function, which will be used as the notification URL for change notifications.</span></span>

1. <span data-ttu-id="d3bbd-125">Создайте новый каталог в каталоге **графтуториалс** с именем **Models**.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-125">Create a new directory in the **GraphTutorials** directory named **Models**.</span></span>

1. <span data-ttu-id="d3bbd-126">Создайте новый файл в каталоге **Models** с именем **ResourceData.CS** и добавьте следующий код.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-126">Create a new file in the **Models** directory named **ResourceData.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ResourceData.cs" id="ResourceDataSnippet":::

1. <span data-ttu-id="d3bbd-127">Создайте новый файл в каталоге **Models** с именем **ChangeNotification.CS** и добавьте следующий код.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-127">Create a new file in the **Models** directory named **ChangeNotification.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/ChangeNotification.cs" id="ChangeNotificationSnippet":::

1. <span data-ttu-id="d3bbd-128">Создайте новый файл в каталоге **Models** с именем **NotificationList.CS** и добавьте следующий код.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-128">Create a new file in the **Models** directory named **NotificationList.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/NotificationList.cs" id="NotificationListSnippet":::

1. <span data-ttu-id="d3bbd-129">Откройте **/графтуториал/нотифи.КС** и замените все содержимое следующим.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-129">Open **./GraphTutorial/Notify.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Notify.cs" id="NotifySnippet":::

<span data-ttu-id="d3bbd-130">Уделите несколько минут, чтобы определить, что делает код в **Notify.CS** .</span><span class="sxs-lookup"><span data-stu-id="d3bbd-130">Take a moment to consider what the code in **Notify.cs** does.</span></span>

- <span data-ttu-id="d3bbd-131">`Run`Функция проверяет наличие `validationToken` параметра запроса.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-131">The `Run` function checks for the presence of a `validationToken` query parameter.</span></span> <span data-ttu-id="d3bbd-132">Если этот параметр присутствует, он обрабатывает запрос как [запрос на проверку](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation)и отвечает соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-132">If that parameter is present, it processes the request as a [validation request](https://docs.microsoft.com/graph/webhooks#notification-endpoint-validation), and responds accordingly.</span></span>
- <span data-ttu-id="d3bbd-133">Если запрос не является запросом проверки, полезная нагрузка JSON десериализуется в объект `NotificationList` .</span><span class="sxs-lookup"><span data-stu-id="d3bbd-133">If the request is not a validation request, the JSON payload is deserialized into a `NotificationList`.</span></span>
- <span data-ttu-id="d3bbd-134">Каждое уведомление в списке проверяется на наличие ожидаемого значения состояния клиента и обрабатывается.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-134">Each notification in the list is checked for the expected client state value, and is processed.</span></span>
- <span data-ttu-id="d3bbd-135">Сообщение, вызвавшее уведомление, будет извлечено в Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-135">The message that triggered the notification is retrieved with Microsoft Graph.</span></span>

## <a name="implement-setsubscription-function"></a><span data-ttu-id="d3bbd-136">Реализация функции Сетсубскриптион</span><span class="sxs-lookup"><span data-stu-id="d3bbd-136">Implement SetSubscription function</span></span>

<span data-ttu-id="d3bbd-137">В этом разделе описывается реализация функции Сетсубскриптион.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-137">In this section, you'll implement the SetSubscription function.</span></span> <span data-ttu-id="d3bbd-138">Эта функция будет использоваться в качестве API, который вызывается тестовым приложением для создания или удаления подписки в папке "Входящие" пользователя.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-138">This function will act as an API that is called by the test application to create or delete a subscription on a user's inbox.</span></span>

1. <span data-ttu-id="d3bbd-139">Создайте новый файл в каталоге **Models** с именем **SetSubscriptionPayload.CS** и добавьте следующий код.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-139">Create a new file in the **Models** directory named **SetSubscriptionPayload.cs** and add the following code.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/Models/SetSubscriptionPayload.cs" id="SetSubscriptionPayloadSnippet":::

1. <span data-ttu-id="d3bbd-140">Откройте **/графтуториал/сетсубскриптион.КС** и замените все содержимое следующим.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-140">Open **./GraphTutorial/SetSubscription.cs** and replace its entire contents with the following.</span></span>

    :::code language="csharp" source="../demo/GraphTutorial/SetSubscription.cs" id="SetSubscriptionSnippet":::

<span data-ttu-id="d3bbd-141">Уделите несколько минут, чтобы определить, что делает код в **SetSubscription.CS** .</span><span class="sxs-lookup"><span data-stu-id="d3bbd-141">Take a moment to consider what the code in **SetSubscription.cs** does.</span></span>

- <span data-ttu-id="d3bbd-142">`Run`Функция считывает полезные данные JSON, отправленные в запросе POST, чтобы определить тип запроса (подписаться или отписаться), идентификатор пользователя для подписки и идентификатор подписки для отказа от подписки.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-142">The `Run` function reads the JSON payload sent in the POST request to determine the request type (subscribe or unsubscribe), the user ID to subscribe for, and the subscription ID to unsubscribe.</span></span>
- <span data-ttu-id="d3bbd-143">Если запрос является запросом на подписку, он использует пакет SDK Microsoft Graph, чтобы создать новую подписку в папке "Входящие" указанного пользователя.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-143">If the request is a subscribe request, it uses the Microsoft Graph SDK to create a new subscription in the specified user's inbox.</span></span> <span data-ttu-id="d3bbd-144">Подписка будет уведомлять о создании или обновлении сообщений.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-144">The subscription will notify when messages are created or updated.</span></span> <span data-ttu-id="d3bbd-145">Новая подписка возвращается в полезных данных JSON ответа.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-145">The new subscription is returned in the JSON payload of the response.</span></span>
- <span data-ttu-id="d3bbd-146">Если запрос является запросом на отмену подписки, он использует пакет SDK Microsoft Graph, чтобы удалить указанную подписку.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-146">If the request is an unsubscribe request, it uses the Microsoft Graph SDK to delete the specified subscription.</span></span>

## <a name="call-setsubscription-from-the-test-app"></a><span data-ttu-id="d3bbd-147">Вызов Сетсубскриптион из тестового приложения</span><span class="sxs-lookup"><span data-stu-id="d3bbd-147">Call SetSubscription from the test app</span></span>

<span data-ttu-id="d3bbd-148">В этом разделе мы реализуем функции для создания и удаления подписок в тестовом приложении.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-148">In this section, you'll implement functions to create and delete subscriptions in the test app.</span></span>

1. <span data-ttu-id="d3bbd-149">Откройте **/тестклиент/azurefunctions.js** и добавьте указанную ниже функцию.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-149">Open **./TestClient/azurefunctions.js** and add the following function.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="createSubscriptionSnippet":::

    <span data-ttu-id="d3bbd-150">Этот код вызывает `SetSubscription` функцию Azure для подписки и добавляет новую подписку в массив подписок в сеансе.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-150">This code calls the `SetSubscription` Azure Function to subscribe and adds the new subscription to the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="d3bbd-151">Добавьте указанную ниже функцию в **azurefunctions.js**.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-151">Add the following function to **azurefunctions.js**.</span></span>

    :::code language="javascript" source="../demo/TestClient/azurefunctions.js" id="deleteSubscriptionSnippet":::

    <span data-ttu-id="d3bbd-152">Этот код вызывает `SetSubscription` функцию Azure для отмены и удаления подписки из массива подписок в сеансе.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-152">This code calls the `SetSubscription` Azure Function to un and removes the subscription from the array of subscriptions in the session.</span></span>

1. <span data-ttu-id="d3bbd-153">Если ngrok не запущены, запустите ngrok ( `ngrok http 7071` ) и скопируйте URL-адрес пересылки HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-153">If you do not have ngrok running, run ngrok (`ngrok http 7071`) and copy the HTTPS forwarding URL.</span></span>

1. <span data-ttu-id="d3bbd-154">Добавьте URL-адрес ngrok в пользовательское хранилище секреты, выполнив следующую команду.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-154">Add the ngrok URL to the user secrets store by running the following command.</span></span>

    ```Shell
    dotnet user-secrets set ngrokUrl "YOUR_NGROK_URL_HERE"
    ```

    > [!IMPORTANT]
    > <span data-ttu-id="d3bbd-155">Если перезапустить ngrok, вам потребуется повторить эту команду, чтобы обновить URL-адрес ngrok.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-155">If you restart ngrok, you will need to repeat this command to update your ngrok URL.</span></span>

1. <span data-ttu-id="d3bbd-156">Измените текущий каталог в командной системе CLI на каталог **./графтуториал** и выполните следующую команду, чтобы запустить функцию Azure локально.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-156">Change the current directory in your CLI to the **./GraphTutorial** directory and run the following command to start the Azure Function locally.</span></span>

    ```Shell
    func start
    ```

1. <span data-ttu-id="d3bbd-157">Обновите SPA и выберите элемент навигации по **подпискам** .</span><span class="sxs-lookup"><span data-stu-id="d3bbd-157">Refresh the SPA and select the **Subscriptions** nav item.</span></span> <span data-ttu-id="d3bbd-158">Введите идентификатор пользователя для пользователя в организации Microsoft 365 с почтовым ящиком Exchange Online.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-158">Enter a user ID for a user in your Microsoft 365 organization that has an Exchange Online mailbox.</span></span> <span data-ttu-id="d3bbd-159">Это может быть либо пользователь `id` (из Microsoft Graph), либо пользователь `userPrincipalName` .</span><span class="sxs-lookup"><span data-stu-id="d3bbd-159">This can either be the user's `id` (from Microsoft Graph) or the user's `userPrincipalName`.</span></span> <span data-ttu-id="d3bbd-160">Нажмите кнопку **подписаться**.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-160">Click **Subscribe**.</span></span>

1. <span data-ttu-id="d3bbd-161">На странице отображается новая подписка в таблице.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-161">The page refreshes showing the new subscription in the table.</span></span>

1. <span data-ttu-id="d3bbd-162">Отправьте пользователю сообщение электронной почты.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-162">Send an email to the user.</span></span> <span data-ttu-id="d3bbd-163">После краткого времени `Notify` необходимо вызвать функцию.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-163">After a brief time, the `Notify` function should be called.</span></span> <span data-ttu-id="d3bbd-164">Это можно проверить в веб-интерфейсе ngrok ( `http://localhost:4040` ) или в выходных данных отладки проекта функции Azure.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-164">You can verify this in the ngrok web interface (`http://localhost:4040`) or in the debug output of the Azure Function project.</span></span>

    ```Shell
    ...
    [7/8/2020 7:33:57 PM] The following message was created:
    [7/8/2020 7:33:57 PM] Subject: Hi Megan!, ID: AAMkAGUyN2I4N2RlLTEzMTAtNDBmYy1hODdlLTY2NTQwODE2MGEwZgBGAAAAAAA2J9QH-DvMRK3pBt_8rA6nBwCuPIFjbMEkToHcVnQirM5qAAAAAAEMAACuPIFjbMEkToHcVnQirM5qAACHmpAsAAA=
    [7/8/2020 7:33:57 PM] Executed 'Notify' (Succeeded, Id=9c40af0b-e082-4418-aa3a-aee624f30e7a)
    ...
    ```

1. <span data-ttu-id="d3bbd-165">В тестовом приложении нажмите кнопку **Delete (удалить** ) в строке таблицы для подписки.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-165">In the test app, click **Delete** in the table row for the subscription.</span></span> <span data-ttu-id="d3bbd-166">Страница обновится, и подписка перестанет быть в таблице.</span><span class="sxs-lookup"><span data-stu-id="d3bbd-166">The page refreshes and the subscription is no longer in the table.</span></span>
